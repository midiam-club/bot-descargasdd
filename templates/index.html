<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Descargas - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-900 text-white font-sans" x-data="downloader()">

    <div class="container mx-auto p-6 space-y-8">
        <header class="flex flex-col xl:flex-row justify-between items-center border-b border-gray-700 pb-6 gap-6">
            <div>
                <h1 class="text-3xl font-bold text-blue-400">Panel de Control</h1>
                <p class="text-gray-400 text-sm mt-1">Gestor de descargas automatizado</p>
            </div>
            
            <div class="flex flex-col md:flex-row gap-4">
                
                <div class="bg-gray-800 p-4 rounded-lg border border-gray-700 flex items-center gap-4 shadow-lg">
                    <span class="text-sm font-semibold text-purple-300">Simult치neas:</span>
                    <div class="flex items-center gap-2">
                        <button @click="changeParallel(-1)" class="w-8 h-8 rounded bg-gray-700 hover:bg-gray-600 flex items-center justify-center font-bold text-xl">-</button>
                        <span class="text-xl font-mono w-8 text-center" x-text="settings.max_parallel">1</span>
                        <button @click="changeParallel(1)" class="w-8 h-8 rounded bg-gray-700 hover:bg-gray-600 flex items-center justify-center font-bold text-xl">+</button>
                    </div>
                </div>

                <div class="bg-gray-800 p-4 rounded-lg border border-gray-700 flex items-center gap-6 shadow-lg">
                    <div class="flex items-center gap-3">
                        <span class="text-sm font-semibold text-gray-300">Limitador:</span>
                        <button 
                            @click="toggleLimit"
                            class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none"
                            :class="settings.enabled ? 'bg-blue-600' : 'bg-gray-600'"
                        >
                            <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform"
                                  :class="settings.enabled ? 'translate-x-6' : 'translate-x-1'"></span>
                        </button>
                    </div>

                    <div class="flex items-center gap-2 border-l border-gray-600 pl-6">
                        <input type="number" step="0.5" min="0" x-model="settings.limit"
                               class="w-16 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-center text-white outline-none">
                        <span class="text-xs text-gray-400">MB/s</span>
                        <button @click="saveLimit" 
                                class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded text-sm font-medium transition-colors">
                            OK
                        </button>
                    </div>
                </div>
            </div>

            <div class="text-right bg-gray-800 p-4 rounded-lg border border-gray-700 min-w-[180px]">
                <p class="text-xs text-gray-400 uppercase tracking-wider">Velocidad Total</p>
                <p class="text-3xl font-mono text-green-400">
                    <span x-text="totalSpeed">0.0</span> <span class="text-lg text-gray-500">MB/s</span>
                </p>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-6">
                <h2 class="text-xl font-semibold flex items-center gap-2 text-blue-300">
                    <span>拘勇</span> Descargas en Curso
                </h2>
                <div x-show="Object.keys(downloads).length === 0" class="bg-gray-800 p-8 rounded-lg text-center border border-gray-700 border-dashed">
                    <p class="text-gray-500">Esperando tareas...</p>
                </div>

                <template x-for="(files, peli) in downloads" :key="peli">
                    <div class="bg-gray-800 rounded-lg p-5 shadow-lg border border-gray-700 relative overflow-hidden"> 
                        
                        <div class="flex justify-between items-end mb-2 relative z-10">
                            <h3 class="text-lg font-bold text-yellow-400 truncate w-3/4" x-text="peli"></h3>
                            <div class="text-right">
                                <span class="text-sm font-mono text-purple-300" x-text="getMovieStats(files).speed + ' MB/s'"></span>
                            </div>
                        </div>

                        <div class="mb-6 relative z-10">
                            <div class="flex justify-between text-xs text-gray-400 mb-1">
                                <span class="uppercase tracking-wider font-semibold text-purple-400">Progreso Total</span>
                                <span x-text="getMovieStats(files).text"></span>
                            </div>
                            <div class="w-full bg-gray-900 rounded-full h-3 relative overflow-hidden border border-gray-600">
                                <div class="bg-purple-600 h-3 rounded-full transition-all duration-500 ease-out shadow-[0_0_10px_rgba(147,51,234,0.5)]"
                                     :style="`width: ${getMovieStats(files).pct}%`">
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-3 pl-2 border-l-2 border-gray-700 relative z-10">
                            <template x-for="(data, filename) in files" :key="filename">
                                <div class="bg-gray-900/40 p-2 rounded border border-gray-700/50">
                                    <div class="flex justify-between text-xs mb-1">
                                        <span class="font-mono text-blue-200 truncate w-2/3" x-text="filename"></span>
                                        <span class="text-green-300" x-text="data.speed + ' MB/s'"></span>
                                    </div>
                                    <div class="w-full bg-gray-700 rounded-full h-1.5 relative overflow-hidden">
                                        <div class="bg-blue-500 h-1.5 rounded-full transition-all duration-500 ease-out"
                                             :style="`width: ${data.progress}%`"></div>
                                    </div>
                                    <div class="flex justify-end mt-0.5">
                                        <span class="text-[10px] text-gray-500" x-text="data.progress + '%'"></span>
                                    </div>
                                </div>
                            </template>
                        </div>

                    </div>
                </template>
            </div>

            <div class="lg:col-span-1">
                <div class="bg-gray-800 p-5 rounded-lg border border-gray-700 sticky top-6 shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-green-300">游늳 Monitor de Red</h2>
                        <span class="text-xs bg-green-900 text-green-300 px-2 py-1 rounded">Live</span>
                    </div>
                    <div class="h-64 relative">
                        <canvas id="speedChart"></canvas>
                        <div class="absolute top-2 right-2 text-right pointer-events-none">
                             <p class="text-xs text-gray-400">Actual</p>
                             <p class="text-xl font-bold text-green-400" x-text="totalSpeed + ' MB/s'"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-8">
            <h2 class="text-xl font-semibold mb-4 flex items-center gap-2 text-purple-300">
                <span>游닄</span> Historial (Sesi칩n)
            </h2>
            <div x-show="Object.keys(history).length === 0" class="text-gray-500 italic text-sm">Vac칤o.</div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <template x-for="(files, peli) in history" :key="peli">
                    <div class="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden">
                        <div class="bg-gray-700/50 px-4 py-3 border-b border-gray-700">
                            <h3 class="font-bold text-gray-200 truncate" x-text="peli"></h3>
                        </div>
                        <div class="p-4">
                            <table class="w-full text-sm text-left text-gray-400">
                                <thead class="text-xs text-gray-500 uppercase bg-gray-900/50">
                                    <tr>
                                        <th class="px-2 py-2">Archivo</th>
                                        <th class="px-2 py-2 text-center">Media</th>
                                        <th class="px-2 py-2 text-right">Tiempo</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="file in files" :key="file.archivo">
                                        <tr class="border-b border-gray-700/50 last:border-0 hover:bg-gray-700/30">
                                            <td class="px-2 py-2 font-mono text-xs text-blue-300 truncate max-w-[150px]" x-text="file.archivo"></td>
                                            <td class="px-2 py-2 text-center text-green-400" x-text="file.avg_speed + ' MB/s'"></td>
                                            <td class="px-2 py-2 text-right text-yellow-200" x-text="file.duration"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('downloader', () => ({
                downloads: {},
                history: {},
                totalSpeed: "0.00",
                settings: { enabled: true, limit: 0, max_parallel: 1 },
                chart: null,

                init() {
                    this.initChart();
                    setInterval(() => this.fetchData(), 1000);
                },

                // Esta funci칩n ahora se llamar치 repetidamente en el template
                getMovieStats(files) {
                    let totalDownloaded = 0;
                    let totalSize = 0;
                    let totalSpeed = 0;
                    
                    // Sumamos los valores de todas las partes
                    Object.values(files).forEach(f => {
                        totalDownloaded += f.downloaded;
                        totalSize += f.total;
                        totalSpeed += f.speed;
                    });

                    let percent = totalSize > 0 ? (totalDownloaded / totalSize) * 100 : 0;
                    
                    // Devolvemos el objeto formateado
                    return {
                        pct: percent.toFixed(1),
                        downloaded: totalDownloaded.toFixed(1),
                        total: totalSize.toFixed(1),
                        speed: totalSpeed.toFixed(1),
                        // Pre-generamos el texto completo para el HTML
                        text: `${totalDownloaded.toFixed(1)} / ${totalSize.toFixed(1)} MB (${percent.toFixed(1)}%)`
                    };
                },

                async fetchData() {
                    try {
                        const res = await fetch('/api/status');
                        const data = await res.json();
                        this.downloads = data.downloads;
                        this.history = data.history;
                        
                        const rawSpeed = data.total_speed; 
                        this.totalSpeed = rawSpeed.toFixed(2); 
                        this.updateChart(rawSpeed);
                        
                        if (document.activeElement.type !== 'number') {
                             this.settings.limit = data.config.limit_value;
                        }
                        this.settings.enabled = data.config.limit_enabled;
                        this.settings.max_parallel = data.config.max_parallel;

                    } catch (e) { console.error(e); }
                },

                async toggleLimit() {
                    this.settings.enabled = !this.settings.enabled;
                    await this.saveLimit();
                },

                async saveLimit() {
                    await fetch('/api/settings/limit', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({enabled: this.settings.enabled, limit: this.settings.limit})
                    });
                },

                async changeParallel(delta) {
                    let newVal = this.settings.max_parallel + delta;
                    if (newVal < 1) newVal = 1;
                    this.settings.max_parallel = newVal;
                    
                    await fetch('/api/settings/parallel', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({max_parallel: newVal})
                    });
                },

                initChart() {
                    const ctx = document.getElementById('speedChart').getContext('2d');
                    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                    gradient.addColorStop(0, 'rgba(74, 222, 128, 0.5)');
                    gradient.addColorStop(1, 'rgba(74, 222, 128, 0.0)');

                    this.chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: Array(30).fill(''), 
                            datasets: [{
                                label: 'MB/s', data: Array(30).fill(0),
                                borderColor: '#4ade80', backgroundColor: gradient,
                                borderWidth: 2, tension: 0.4, fill: true, pointRadius: 0
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false, animation: { duration: 0 },
                            interaction: { intersect: false, mode: 'index' },
                            scales: { 
                                y: { beginAtZero: true, grid: { color: '#374151' }, ticks: { color: '#9ca3af' } }, 
                                x: { display: false } 
                            },
                            plugins: { legend: { display: false } }
                        }
                    });
                },

                updateChart(val) {
                    if (!this.chart) return;
                    const data = this.chart.data.datasets[0].data;
                    data.shift();
                    data.push(Number(val)); 
                    this.chart.update();
                }
            }))
        });
    </script>
</body>
</html>