<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Dashboard</title>
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        /* Animaci√≥n para la barra de descompresi√≥n */
        @keyframes stripes {
            from { background-position: 0 0; }
            to { background-position: 20px 20px; }
        }
        .animate-stripes {
            background-image: linear-gradient(45deg, rgba(255, 255, 255, 0.15) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.15) 50%, rgba(255, 255, 255, 0.15) 75%, transparent 75%, transparent);
            background-size: 20px 20px;
            animation: stripes 1s linear infinite;
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans h-screen overflow-hidden" x-data="downloader()">

    <div class="flex h-full">
        
        <aside class="w-80 bg-gray-800 border-r border-gray-700 flex flex-col p-6 gap-8 shadow-2xl z-20">
            <div class="flex justify-center">
                <img src="/static/sidebar-logo.png" alt="Logo" class="h-12">
            </div>

            <div class="bg-gray-900/50 p-4 rounded-xl border border-gray-700 text-center">
                <p class="text-xs text-gray-400 uppercase tracking-widest mb-1">Velocidad Actual</p>
                <div class="flex items-baseline justify-center gap-1">
                    <span class="text-4xl font-mono font-bold text-green-400" x-text="totalSpeed">0.0</span>
                    <span class="text-sm text-gray-500">MB/s</span>
                </div>
            </div>

            <div class="flex-1 min-h-[150px] flex flex-col">
                <h3 class="text-sm font-semibold text-gray-300 mb-3 flex items-center gap-2">
                    <span>üìà</span> Actividad de Red
                </h3>
                <div class="relative flex-1 w-full bg-gray-900 rounded-lg border border-gray-700 p-2">
                    <canvas id="speedChart"></canvas>
                </div>
            </div>

            <div class="space-y-6">
                <div class="space-y-2">
                    <label class="text-xs font-semibold text-purple-300 uppercase">Hilos Simult√°neos</label>
                    <div class="flex items-center justify-between bg-gray-900 p-2 rounded border border-gray-700">
                        <button @click="changeParallel(-1)" class="w-8 h-8 rounded bg-gray-800 hover:bg-gray-700 text-white font-bold transition">-</button>
                        <span class="text-xl font-mono font-bold" x-text="settings.max_parallel">...</span>
                        <button @click="changeParallel(1)" class="w-8 h-8 rounded bg-gray-800 hover:bg-gray-700 text-white font-bold transition">+</button>
                    </div>
                </div>

                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <label class="text-xs font-semibold text-gray-300 uppercase">L√≠mite Global</label>
                        <button @click="toggleLimit" class="relative inline-flex h-5 w-9 items-center rounded-full transition-colors focus:outline-none" :class="settings.enabled ? 'bg-blue-600' : 'bg-gray-600'">
                            <span class="inline-block h-3 w-3 transform rounded-full bg-white transition-transform" :class="settings.enabled ? 'translate-x-5' : 'translate-x-1'"></span>
                        </button>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="number" step="0.5" min="0" x-model="settings.limit" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-center text-white outline-none focus:border-blue-500 transition">
                        <button @click="saveLimit" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-2 rounded text-sm font-bold transition">OK</button>
                    </div>
                </div>
            </div>

            <div class="text-center text-[10px] text-gray-600 mt-auto">v2.7 &bull; Dockerized</div>
        </aside>

        <main class="flex-1 flex flex-col overflow-hidden bg-gray-900 relative">
            
            <div class="flex-1 overflow-y-auto p-8 space-y-10">
                
                <section>
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-pink-400">
                        <span>üöÄ</span> Novedades Detectadas en Foro
                    </h2>
                    <div x-show="detected.length === 0" class="text-gray-500 italic text-sm bg-gray-800/50 p-4 rounded border border-gray-800 border-dashed">
                        No hay novedades pendientes de procesar.
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                        <template x-for="(mov, idx) in detected" :key="idx">
                            <div class="bg-gray-800 p-4 rounded-lg border border-gray-700 hover:border-gray-600 transition shadow-lg group">
                                <div class="flex justify-between items-start mb-2">
                                    <span class="text-xs font-bold text-gray-500" x-text="mov.anio"></span>
                                    <span class="px-2 py-0.5 rounded bg-pink-900/30 border border-pink-500/30 text-pink-300 text-[10px] font-bold uppercase" x-text="mov.formato"></span>
                                </div>
                                <h3 class="font-bold text-gray-200 truncate group-hover:text-white transition" x-text="mov.titulo"></h3>
                                <div class="mt-3 w-full bg-gray-700 h-1 rounded-full overflow-hidden">
                                    <div class="h-full bg-pink-500 w-1/3 animate-pulse"></div>
                                </div>
                            </div>
                        </template>
                    </div>
                </section>

                <hr class="border-gray-800">

                <section>
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-blue-400">
                        <span>‚¨áÔ∏è</span> Tareas en Progreso
                    </h2>

                    <div x-show="Object.keys(downloads).length === 0" class="bg-gray-800/50 p-8 rounded-lg text-center border border-gray-800 border-dashed">
                        <p class="text-gray-500">El gestor est√° esperando nuevas descargas...</p>
                    </div>

                    <div class="space-y-6">
                        <template x-for="(files, peli) in downloads" :key="peli">
                            <div class="bg-gray-800 rounded-xl p-6 shadow-xl border border-gray-700 relative overflow-hidden">
                                
                                <div class="flex justify-between items-end mb-4 relative z-10">
                                    <div class="flex items-center gap-3 w-3/4 overflow-hidden">
                                        <h3 class="text-xl font-bold text-yellow-400 truncate" x-text="peli"></h3>
                                        <template x-if="formats && formats[peli]">
                                            <span class="px-2 py-0.5 rounded bg-blue-900 border border-blue-500 text-blue-200 text-xs font-bold uppercase tracking-wider shadow-sm" x-text="formats[peli]"></span>
                                        </template>
                                    </div>
                                    <div class="text-right">
                                        <template x-if="!getMovieStats(files).isExtracting">
                                            <span class="text-lg font-mono text-purple-300 font-bold" x-text="getMovieStats(files).speed + ' MB/s'"></span>
                                        </template>
                                        <template x-if="getMovieStats(files).isExtracting">
                                            <span class="text-lg font-mono text-orange-400 font-bold animate-pulse">UNRAR</span>
                                        </template>
                                    </div>
                                </div>

                                <div class="mb-6 relative z-10 bg-gray-900/50 p-3 rounded-lg border border-gray-700/50">
                                    
                                    <div class="flex justify-between text-xs text-gray-400 mb-2">
                                        
                                        <template x-if="getMovieStats(files).isExtracting">
                                            <span class="uppercase tracking-wider font-bold text-orange-400">Descomprimiendo</span>
                                        </template>
                                        <template x-if="!getMovieStats(files).isExtracting">
                                            <span class="uppercase tracking-wider font-semibold text-purple-400">Progreso Descarga</span>
                                        </template>

                                        <span class="font-mono" x-text="getMovieStats(files).text"></span>
                                    </div>

                                    <div class="w-full bg-gray-900 rounded-full h-4 relative overflow-hidden border border-gray-600">
                                        <div x-show="!getMovieStats(files).isExtracting"
                                             class="bg-gradient-to-r from-purple-600 to-blue-500 h-4 rounded-full transition-all duration-500 ease-out shadow-[0_0_15px_rgba(147,51,234,0.3)]"
                                             :style="`width: ${getMovieStats(files).pct}%`"></div>
                                        
                                        <div x-show="getMovieStats(files).isExtracting"
                                             class="bg-orange-500 h-4 rounded-full transition-all duration-300 ease-out shadow-[0_0_15px_rgba(249,115,22,0.5)] animate-stripes"
                                             :style="`width: ${getMovieStats(files).pct}%`"></div>
                                    </div>
                                </div>
                                
                                <div class="space-y-2 pl-2 border-l-2 border-gray-700 relative z-10">
                                    <template x-for="(data, filename) in filterFiles(files)" :key="filename">
                                        <div x-show="filename !== 'üì¶ Descomprimiendo...'" 
                                             class="bg-gray-900/60 p-3 rounded-md border border-gray-700/50 flex flex-col gap-2 transition hover:bg-gray-900"
                                             :class="{
                                                'border-green-500/30': data.status === 'completed'
                                             }">
                                            
                                            <div class="flex justify-between text-xs items-center">
                                                <div class="flex items-center gap-3 truncate max-w-[70%]">
                                                    <div class="w-5 flex justify-center">
                                                        <span x-show="data.status === 'downloading'">‚¨áÔ∏è</span>
                                                        <span x-show="data.status === 'completed'">‚úÖ</span>
                                                    </div>
                                                    
                                                    <span class="font-mono text-gray-300 truncate text-sm" 
                                                          :class="data.status === 'completed' ? 'line-through opacity-50' : ''"
                                                          x-text="filename"></span>
                                                    
                                                    <div class="hidden sm:flex items-center gap-2 opacity-70 ml-2">
                                                        <div x-show="data.host" class="flex items-center gap-1">
                                                            <span class="text-[10px] text-gray-500" x-text="data.host"></span>
                                                            <span class="text-[10px] font-bold bg-gray-800 px-1 rounded text-blue-300" x-text="data.debrid"></span>
                                                        </div>
                                                        <span class="text-[10px] text-gray-400 border-l border-gray-600 pl-2" x-text="formatSize(data.total)"></span>
                                                    </div>
                                                </div>

                                                <div class="text-right min-w-[80px]">
                                                    <span x-show="data.status === 'downloading'" class="text-green-400 font-mono" x-text="data.speed + ' MB/s'"></span>
                                                    <span x-show="data.status === 'completed'" class="text-gray-500 font-semibold">LISTO</span>
                                                </div>
                                            </div>
                                            
                                            <div class="w-full bg-gray-800 rounded-full h-1 overflow-hidden">
                                                <div class="h-1 rounded-full transition-all duration-300"
                                                     :class="{
                                                         'bg-blue-500': data.status === 'downloading',
                                                         'bg-green-500': data.status === 'completed'
                                                     }"
                                                     :style="`width: ${data.progress}%`"></div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                </section>
                
                <hr class="border-gray-800">

                <section>
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-purple-400">
                        <span>üìö</span> Historial de Sesi√≥n
                    </h2>
                    <div x-show="Object.keys(history).length === 0" class="text-gray-500 italic text-sm">Historial vac√≠o.</div>
                    <div class="grid grid-cols-1 xl:grid-cols-2 gap-4">
                        <template x-for="(files, peli) in history" :key="peli">
                            <div class="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden shadow-sm hover:shadow-md transition">
                                <div class="bg-gray-750 px-4 py-3 border-b border-gray-700 flex justify-between items-center bg-gray-900/30">
                                    <h3 class="font-bold text-gray-300 truncate w-2/3 text-sm" x-text="peli"></h3>
                                    <div x-show="completed.includes(peli)" class="flex items-center gap-1 bg-green-900/30 border border-green-700/50 px-2 py-0.5 rounded text-green-400 text-[10px] font-bold"><span>COMPLETO</span></div>
                                </div>
                                <div class="p-3 max-h-40 overflow-y-auto">
                                    <table class="w-full text-xs text-left text-gray-400">
                                        <thead class="text-[10px] text-gray-500 uppercase bg-gray-900/30">
                                            <tr>
                                                <th class="px-2 py-1">Archivo</th>
                                                <th class="px-2 py-1">Tama√±o</th>
                                                <th class="px-2 py-1 text-center">Vel</th>
                                                <th class="px-2 py-1 text-right">Tiempo</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <template x-for="file in files" :key="file.archivo">
                                                <tr class="border-b border-gray-700/30 last:border-0 hover:bg-gray-700/10">
                                                    <td class="py-1 px-2 font-mono text-blue-300 truncate max-w-[150px]" x-text="file.archivo"></td>
                                                    <td class="py-1 px-2 text-gray-400" x-text="formatSize(file.size)"></td>
                                                    <td class="py-1 px-2 text-center text-green-500/80" x-text="file.avg_speed + ' MB/s'"></td>
                                                    <td class="py-1 pl-2 pr-2 text-right text-gray-500" x-text="file.duration"></td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </template>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('downloader', () => ({
                downloads: {},
                history: {},
                completed: [],
                formats: {}, 
                detected: [],
                totalSpeed: "0.00",
                settings: { enabled: true, limit: 0, max_parallel: 1 },
                chart: null,

                init() {
                    this.initChart();
                    this.fetchData(); 
                    setInterval(() => this.fetchData(), 1000);
                },

                formatSize(mb) {
                    if (!mb) return '0 MB';
                    if (mb >= 1024) return (mb / 1024).toFixed(2) + ' GB';
                    return mb.toFixed(1) + ' MB';
                },

                filterFiles(files) {
                    const { __meta__, ...rest } = files;
                    return rest;
                },

                getMovieStats(files) {
                    const meta = files.__meta__ || { total_parts: 1 };
                    const totalExpected = meta.total_parts;
                    
                    let totalSpeed = 0;
                    let completedParts = 0;
                    let partialProgressSum = 0;
                    let downloadedBytes = 0;
                    
                    // --- DETECCI√ìN DE EXTRACCI√ìN ---
                    // Buscamos si existe la key especial de descompresi√≥n
                    let extractionEntry = files["üì¶ Descomprimiendo..."];
                    let isExtracting = !!extractionEntry;
                    
                    Object.entries(files).forEach(([key, f]) => {
                        if (key === '__meta__') return;
                        if (key === 'üì¶ Descomprimiendo...') return; // No sumar al download total
                        
                        downloadedBytes += f.downloaded;
                        if(f.status === 'downloading') totalSpeed += f.speed;
                        if (f.status === 'completed') completedParts += 1;
                        else if (f.status === 'downloading') partialProgressSum += (f.progress / 100);
                    });

                    // SI EST√Å DESCOMPRIMIENDO, LA BARRA MUESTRA EL PROGRESO DE UNRAR
                    if (isExtracting) {
                        return {
                            pct: extractionEntry.progress,
                            speed: 0,
                            isExtracting: true,
                            text: `Extrayendo: ${extractionEntry.progress}%`
                        };
                    }

                    // SI NO, MUESTRA EL DE DESCARGA NORMAL
                    let rawPercent = ((completedParts + partialProgressSum) / totalExpected) * 100;
                    if (rawPercent > 100) rawPercent = 100;
                    const downloadedGB = (downloadedBytes / 1024).toFixed(2);
                    
                    return {
                        pct: rawPercent.toFixed(1),
                        speed: totalSpeed.toFixed(1),
                        isExtracting: false,
                        text: `${downloadedGB} GB | ${completedParts}/${totalExpected} Partes`
                    };
                },

                async fetchData() {
                    try {
                        const res = await fetch('/api/status');
                        const data = await res.json();
                        this.downloads = data.downloads;
                        this.history = data.history;
                        this.completed = data.completed || [];
                        this.formats = data.formats || {}; 
                        this.detected = data.detected || [];
                        
                        const rawSpeed = data.total_speed; 
                        this.totalSpeed = rawSpeed.toFixed(2); 
                        this.updateChart(rawSpeed);
                        
                        if (document.activeElement.type !== 'number') {
                             this.settings.limit = data.config.limit_value;
                        }
                        this.settings.enabled = data.config.limit_enabled;
                        this.settings.max_parallel = data.config.max_parallel;

                    } catch (e) { console.error(e); }
                },

                async toggleLimit() {
                    this.settings.enabled = !this.settings.enabled;
                    await this.saveLimit();
                },

                async saveLimit() {
                    await fetch('/api/settings/limit', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({enabled: this.settings.enabled, limit: this.settings.limit})
                    });
                },

                async changeParallel(delta) {
                    let newVal = this.settings.max_parallel + delta;
                    if (newVal < 1) newVal = 1;
                    this.settings.max_parallel = newVal;
                    
                    await fetch('/api/settings/parallel', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({max_parallel: newVal})
                    });
                },

                initChart() {
                    const ctx = document.getElementById('speedChart').getContext('2d');
                    const gradient = ctx.createLinearGradient(0, 0, 0, 150);
                    gradient.addColorStop(0, 'rgba(59, 130, 246, 0.5)'); 
                    gradient.addColorStop(1, 'rgba(59, 130, 246, 0.0)');

                    this.chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: Array(30).fill(''), 
                            datasets: [{
                                label: 'MB/s', 
                                data: Array(30).fill(0),
                                borderColor: '#3b82f6', 
                                backgroundColor: gradient,
                                borderWidth: 2, 
                                tension: 0.3, 
                                fill: true, 
                                pointRadius: 0
                            }]
                        },
                        options: {
                            responsive: true, 
                            maintainAspectRatio: false, 
                            animation: false,
                            interaction: { intersect: false, mode: 'index' },
                            scales: { 
                                y: { 
                                    beginAtZero: true, 
                                    display: true,
                                    grid: { color: '#374151', drawBorder: false }, 
                                    ticks: { color: '#9ca3af', font: {size: 10} } 
                                }, 
                                x: { display: false } 
                            },
                            plugins: { legend: { display: false } }
                        }
                    });
                },

                updateChart(val) {
                    if (!this.chart) return;
                    const data = this.chart.data.datasets[0].data;
                    data.shift();
                    data.push(parseFloat(val));
                    this.chart.update('none');
                }
            }))
        });
    </script>
</body>
</html>